---
const base = import.meta.env.BASE_URL || '/';
---
<header id="site-header" class="w-full bg-neuro-background fixed top-0 z-50 transition-colors">
  <div class="w-full px-4 py-4 flex items-center justify-between">
    <!-- Izquierda: Logo -->
    <a href={base} class="inline-flex items-center hover:scale-105 transition-transform">
      <img src={`${base}images/logo.png`} alt="NeuroVivir" class="logo-img h-10 md:h-12 object-contain" fetchpriority="high" />
    </a>

    <!-- Centro: Navegación (desktop) -->
  <nav class="hidden md:flex gap-6 text-lg">
      <div class="relative" id="svc-dd">
        <button id="svc-trigger" class="inline-flex items-center gap-2 rounded-4xl border border-transparent px-0 py-0 bg-transparent hover:text-neuro-title transition-colors">
          <span id="svc-label-es" class="hidden">Servicios</span>
          <span id="svc-label-en">Services</span>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div id="svc-menu" class="absolute left-0 top-full mt-2 hidden">
          <div class="rounded-4xl shadow-lg border border-neuro-detail bg-white text-neuro-title p-2 md:p-4 flex min-w-[640px]">
            <div class="w-52 pr-3 md:pr-4 space-y-2">
              <button id="svc-tab-therapies" class="w-full inline-flex items-center justify-between rounded-4xl px-3 py-2 bg-white text-neuro-title opacity-80 hover:bg-neuro-detail/10 hover:opacity-100">
                <span id="tab-therapies-es" class="hidden">Terapias</span>
                <span id="tab-therapies-en">Therapies</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
              <button id="svc-tab-treatments" class="w-full inline-flex items-center justify-between rounded-4xl px-3 py-2 bg-white text-neuro-title opacity-80 hover:bg-neuro-detail/10 hover:opacity-100">
                <span id="tab-treatments-es" class="hidden">Tratamientos</span>
                <span id="tab-treatments-en">Treatments</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            </div>
            <div class="w-px bg-neuro-detail/40 mx-2 md:mx-3"></div>
            <div class="flex-1 pl-2 md:pl-3">
              <ul id="svc-list-therapies" class="grid grid-cols-1 gap-2">
                <li><a href={`${base}therapies/individual-therapy`} class="text-neuro-title rounded-4xl px-3 py-2 hover:underline"><span id="th-individual-es" class="hidden">Terapia individual</span><span id="th-individual-en">Individual therapy</span></a></li>
                <li><a href={`${base}therapies/couples-therapy`} class="text-neuro-title rounded-4xl px-3 py-2 hover:underline"><span id="th-couples-es" class="hidden">Terapia de pareja</span><span id="th-couples-en">Couples therapy</span></a></li>
                <li><a href={`${base}therapies/teen-therapy`} class="text-neuro-title rounded-4xl px-3 py-2 hover:underline"><span id="th-teen-es" class="hidden">Terapia para adolescentes</span><span id="th-teen-en">Teen therapy</span></a></li>
                <li><a href={`${base}therapies/domestic-violence`} class="text-neuro-title rounded-4xl px-3 py-2 hover:underline"><span id="th-domestic-es" class="hidden">Violencia doméstica</span><span id="th-domestic-en">Domestic violence</span></a></li>
                <li><a href={`${base}therapies/evaluations`} class="text-neuro-title rounded-4xl px-3 py-2 hover:underline"><span id="th-evaluations-es" class="hidden">Evaluación psicológica</span><span id="th-evaluations-en">Psychological evaluation</span></a></li>
                <li><a href={`${base}therapies/post-crash-support`} class="text-neuro-title rounded-4xl px-3 py-2 hover:underline"><span id="th-postcrash-es" class="hidden">Apoyo post choque</span><span id="th-postcrash-en">Post-crash support</span></a></li>
              </ul>
              <ul id="svc-list-treatments" class="grid grid-cols-1 gap-2 hidden">
                <li><a href={`${base}treatments/migration-stress`} class="text-neuro-title rounded-4xl px-3 py-2 hover:underline"><span id="tr-migration-es" class="hidden">Estrés por migración</span><span id="tr-migration-en">Migration stress</span></a></li>
                <li><a href={`${base}treatments/anxiety`} class="text-neuro-title rounded-4xl px-3 py-2 hover:underline"><span id="tr-anxiety-es" class="hidden">Ansiedad</span><span id="tr-anxiety-en">Anxiety</span></a></li>
                <li><a href={`${base}treatments/depression`} class="text-neuro-title rounded-4xl px-3 py-2 hover:underline"><span id="tr-depression-es" class="hidden">Depresión</span><span id="tr-depression-en">Depression</span></a></li>
                <li><a href={`${base}treatments/grief`} class="text-neuro-title rounded-4xl px-3 py-2 hover:underline"><span id="tr-grief-es" class="hidden">Duelo</span><span id="tr-grief-en">Grief</span></a></li>
                <li><a href={`${base}treatments/self-esteem`} class="text-neuro-title rounded-4xl px-3 py-2 hover:underline"><span id="tr-selfesteem-es" class="hidden">Autoestima</span><span id="tr-selfesteem-en">Self-esteem</span></a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <a href={`${base}blog`} class="hover:text-neuro-title transition-colors"><span id="nav-blog-es" class="hidden">Blog</span><span id="nav-blog-en">Blog</span></a>
      <a href={`${base}faq`} class="hover:text-neuro-title transition-colors"><span id="nav-faq-es" class="hidden">FAQ</span><span id="nav-faq-en">FAQ</span></a>
      <a href={`${base}contact`} class="hover:text-neuro-title transition-colors"><span id="nav-contact-es" class="hidden">Contacto</span><span id="nav-contact-en">Contact</span></a>
    </nav>

    <!-- Derecha: Teléfono + CTA + Redes + Idioma (desktop) -->
    <div class="hidden md:flex items-center gap-4">
      <div class="flex items-center gap-3">
        <a href="#" aria-label="Instagram" class="social p-2 rounded-4xl border-2 border-neuro-detail hover:scale-105 transition-transform">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="5" stroke="currentColor"/><circle cx="12" cy="12" r="4" stroke="currentColor"/><circle cx="17.5" cy="6.5" r="1.5" fill="currentColor"/></svg>
        </a>
        <a href="#" aria-label="Facebook" class="social p-2 rounded-4xl border-2 border-neuro-detail hover:scale-105 transition-transform">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M14 9h3V6h-3c-2.21 0-4 1.79-4 4v2H8v3h2v6h3v-6h3l1-3h-4v-2c0-.55.45-1 1-1z" fill="currentColor"/></svg>
        </a>
      </div>
      <div class="flex items-center gap-2" id="lang-toggle-desktop">
        <button id="lang-es" class="text-neuro-title opacity-100 font-semibold">ES</button>
        <span class="text-neuro-paragraph">|</span>
        <button id="lang-en" class="text-neuro-paragraph opacity-60">EN</button>
      </div>
      <a href="tel:+15551234567" class="phone text-lg md:text-xl ml-auto hover:underline" aria-label="Call (555) 123-4567">(555) 123-4567</a>
      <a href="#book" class="rounded-4xl bg-neuro-primaryButton text-white px-6 py-3 text-base md:text-lg hover:scale-105 transition-transform">
        <span id="cta-es">Agendar ahora</span>
        <span id="cta-en" class="hidden">Book now</span>
      </a>
    </div>

    <!-- Mobile: Logo + Idioma + Hamburguesa -->
    <div class="flex md:hidden items-center gap-3">
      <div class="flex items-center gap-2" id="lang-toggle-mobile">
        <button id="m-lang-es" class="text-neuro-title opacity-100 font-semibold">ES</button>
        <span class="text-neuro-paragraph">|</span>
        <button id="m-lang-en" class="text-neuro-paragraph opacity-60">EN</button>
      </div>
      <button id="menu-btn" aria-expanded="false" aria-controls="mobile-menu" class="p-2 rounded-4xl border border-neuro-detail hover:scale-105 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2"/></svg>
      </button>
    </div>
  </div>

  <!-- Mobile menu panel -->
  <div id="mobile-menu" class="md:hidden hidden border-t border-neuro-detail">
      <div class="w-full px-4 py-4 flex flex-col gap-4">
        <a href={`${base}therapies`} class="hover:text-neuro-title transition-colors"><span id="m-nav-services-es" class="hidden">Terapias</span><span id="m-nav-services-en">Therapies</span></a>
        <a href={`${base}blog`} class="hover:text-neuro-title transition-colors"><span id="m-nav-blog-es" class="hidden">Blog</span><span id="m-nav-blog-en">Blog</span></a>
        <a href={`${base}faq`} class="hover:text-neuro-title transition-colors"><span id="m-nav-faq-es" class="hidden">FAQ</span><span id="m-nav-faq-en">FAQ</span></a>
        <a href={`${base}contact`} class="hover:text-neuro-title transition-colors"><span id="m-nav-contact-es" class="hidden">Contacto</span><span id="m-nav-contact-en">Contact</span></a>
        <div class="flex items-center justify-between pt-2">
          <a href="tel:+15551234567" class="phone hover:underline" aria-label="Call (555) 123-4567">(555) 123-4567</a>
          <a href="#book" class="rounded-4xl bg-neuro-primaryButton text-white px-5 py-2 text-sm hover:scale-105 transition-transform">
            <span id="m-cta-es">Agendar ahora</span>
            <span id="m-cta-en" class="hidden">Book now</span>
          </a>
        </div>
        <div class="flex items-center gap-3">
          <a href="#" aria-label="Instagram" class="social p-2 rounded-4xl border-2 border-neuro-detail hover:scale-105 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="5" stroke="currentColor"/><circle cx="12" cy="12" r="4" stroke="currentColor"/><circle cx="17.5" cy="6.5" r="1.5" fill="currentColor"/></svg>
          </a>
          <a href="#" aria-label="Facebook" class="social p-2 rounded-4xl border-2 border-neuro-detail hover:scale-105 transition-transform">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M14 9h3V6h-3c-2.21 0-4 1.79-4 4v2H8v3h2v6h3v-6h3l1-3h-4v-2c0-.55.45-1 1-1z" fill="currentColor"/></svg>
          </a>
        </div>
      </div>
    </div>
</header>

<style>
  #site-header.nav-top { background-color: transparent }
  #site-header.nav-solid { background-color: var(--neuro-background) }
  #site-header.nav-top nav > a { color: #fff !important }
  #site-header.nav-top #svc-trigger { color: #fff }
  #site-header.nav-top #svc-trigger.is-open { color: var(--neuro-title) !important }
  #site-header.nav-top .phone { color: #fff !important }
  #site-header.nav-top #lang-toggle-desktop button, #site-header.nav-top #lang-toggle-desktop span, #site-header.nav-top #lang-toggle-mobile button, #site-header.nav-top #lang-toggle-mobile span { color: #fff !important }
  #site-header.nav-top .social svg { color: #fff }
  #site-header.nav-top .logo-img { filter: brightness(0) invert(1) }
</style>

<script type="module">
  import { initLang, getLang, setLang, onLangChange } from "/src/lib/i18n/languageStore.ts";
  initLang();
  const updateLangUI = (lang) => {
    const esBtn = document.getElementById('lang-es');
    const enBtn = document.getElementById('lang-en');
    const mEsBtn = document.getElementById('m-lang-es');
    const mEnBtn = document.getElementById('m-lang-en');
    const ctaEs = document.getElementById('cta-es');
    const ctaEn = document.getElementById('cta-en');
    const mCtaEs = document.getElementById('m-cta-es');
    const mCtaEn = document.getElementById('m-cta-en');
    const pairs = [
      ['svc-label-es','svc-label-en'],
      ['tab-therapies-es','tab-therapies-en'],
      ['tab-treatments-es','tab-treatments-en'],
      ['th-individual-es','th-individual-en'],
      ['th-couples-es','th-couples-en'],
      ['th-teen-es','th-teen-en'],
      ['th-domestic-es','th-domestic-en'],
      ['th-evaluations-es','th-evaluations-en'],
      ['th-postcrash-es','th-postcrash-en'],
      ['tr-migration-es','tr-migration-en'],
      ['tr-anxiety-es','tr-anxiety-en'],
      ['tr-depression-es','tr-depression-en'],
      ['tr-grief-es','tr-grief-en'],
      ['tr-selfesteem-es','tr-selfesteem-en'],
      ['nav-blog-es','nav-blog-en'],
      ['nav-faq-es','nav-faq-en'],
      ['nav-contact-es','nav-contact-en'],
      ['m-nav-services-es','m-nav-services-en'],
      ['m-nav-blog-es','m-nav-blog-en'],
      ['m-nav-faq-es','m-nav-faq-en'],
      ['m-nav-contact-es','m-nav-contact-en'],
    ];

    if (!esBtn || !enBtn || !mEsBtn || !mEnBtn) return;

    if (lang === 'es') {
      esBtn.classList.add('text-neuro-title');
      esBtn.classList.remove('text-neuro-paragraph');
      esBtn.classList.add('opacity-100','font-semibold');
      esBtn.classList.remove('opacity-60');
      enBtn.classList.add('text-neuro-paragraph');
      enBtn.classList.remove('text-neuro-title');
      enBtn.classList.add('opacity-60');
      enBtn.classList.remove('opacity-100','font-semibold');
      mEsBtn.classList.add('text-neuro-title');
      mEsBtn.classList.remove('text-neuro-paragraph');
      mEsBtn.classList.add('opacity-100','font-semibold');
      mEsBtn.classList.remove('opacity-60');
      mEnBtn.classList.add('text-neuro-paragraph');
      mEnBtn.classList.remove('text-neuro-title');
      mEnBtn.classList.add('opacity-60');
      mEnBtn.classList.remove('opacity-100','font-semibold');
      if (ctaEs && ctaEn) { ctaEs.classList.remove('hidden'); ctaEn.classList.add('hidden'); }
      if (mCtaEs && mCtaEn) { mCtaEs.classList.remove('hidden'); mCtaEn.classList.add('hidden'); }
      pairs.forEach(([esId, enId]) => {
        const esEl = document.getElementById(esId);
        const enEl = document.getElementById(enId);
        esEl?.classList.remove('hidden');
        enEl?.classList.add('hidden');
      });
    } else {
      enBtn.classList.add('text-neuro-title');
      enBtn.classList.remove('text-neuro-paragraph');
      enBtn.classList.add('opacity-100','font-semibold');
      enBtn.classList.remove('opacity-60');
      esBtn.classList.add('text-neuro-paragraph');
      esBtn.classList.remove('text-neuro-title');
      esBtn.classList.add('opacity-60');
      esBtn.classList.remove('opacity-100','font-semibold');
      mEnBtn.classList.add('text-neuro-title');
      mEnBtn.classList.remove('text-neuro-paragraph');
      mEnBtn.classList.add('opacity-100','font-semibold');
      mEnBtn.classList.remove('opacity-60');
      mEsBtn.classList.add('text-neuro-paragraph');
      mEsBtn.classList.remove('text-neuro-title');
      mEsBtn.classList.add('opacity-60');
      mEsBtn.classList.remove('opacity-100','font-semibold');
      if (ctaEs && ctaEn) { ctaEs.classList.add('hidden'); ctaEn.classList.remove('hidden'); }
      if (mCtaEs && mCtaEn) { mCtaEs.classList.add('hidden'); mCtaEn.classList.remove('hidden'); }
      pairs.forEach(([esId, enId]) => {
        const esEl = document.getElementById(esId);
        const enEl = document.getElementById(enId);
        esEl?.classList.add('hidden');
        enEl?.classList.remove('hidden');
      });
    }
  };

  updateLangUI(getLang());
  onLangChange(updateLangUI);

  const bindToggle = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('click', () => setLang(value));
  };
  bindToggle('lang-es', 'es');
  bindToggle('lang-en', 'en');
  bindToggle('m-lang-es', 'es');
  bindToggle('m-lang-en', 'en');

  const menuBtn = document.getElementById('menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  if (menuBtn && mobileMenu) {
    menuBtn.addEventListener('click', () => {
      const open = mobileMenu.classList.toggle('hidden');
      menuBtn.setAttribute('aria-expanded', (!open).toString());
    });
  }

  const headerEl = document.getElementById('site-header');
  const setTopState = () => {
    const atTop = window.scrollY < 10;
    if (!headerEl) return;
    headerEl.classList.toggle('nav-top', atTop);
    headerEl.classList.toggle('nav-solid', !atTop);
  };
  setTopState();
  window.addEventListener('scroll', setTopState);

  const svcDd = document.getElementById('svc-dd');
  const svcTrigger = document.getElementById('svc-trigger');
  const svcMenu = document.getElementById('svc-menu');
  const tabTherapies = document.getElementById('svc-tab-therapies');
  const tabTreatments = document.getElementById('svc-tab-treatments');
  const listTherapies = document.getElementById('svc-list-therapies');
  const listTreatments = document.getElementById('svc-list-treatments');
  let svcHideTimer;
  const openSvc = () => {
    if (!svcMenu) return;
    clearTimeout(svcHideTimer);
    svcMenu.classList.remove('hidden');
    svcTrigger?.classList.add('text-neuro-title','is-open');
  };
  const closeSvc = () => {
    if (!svcMenu) return;
    svcMenu.classList.add('hidden');
    svcTrigger?.classList.remove('text-neuro-title','is-open');
  };
  const showTherapies = () => {
    tabTherapies?.classList.add('bg-neuro-detail/10');
    tabTherapies?.classList.remove('bg-white','border','border-neuro-detail','border-transparent');
    tabTreatments?.classList.add('bg-white');
    tabTreatments?.classList.remove('bg-neuro-detail/10','border','border-neuro-detail','border-transparent');
    listTherapies?.classList.remove('hidden');
    listTreatments?.classList.add('hidden');
  };
  const showTreatments = () => {
    tabTreatments?.classList.add('bg-neuro-detail/10');
    tabTreatments?.classList.remove('bg-white','border','border-neuro-detail','border-transparent');
    tabTherapies?.classList.add('bg-white');
    tabTherapies?.classList.remove('bg-neuro-detail/10','border','border-neuro-detail','border-transparent');
    listTreatments?.classList.remove('hidden');
    listTherapies?.classList.add('hidden');
  };
  showTherapies();
  if (svcDd && svcMenu) {
    svcDd.addEventListener('pointerenter', openSvc);
    svcDd.addEventListener('pointerleave', () => {
      clearTimeout(svcHideTimer);
      svcHideTimer = setTimeout(closeSvc, 160);
    });
    svcTrigger?.addEventListener('click', () => {
      if (!svcMenu) return;
      const hidden = svcMenu.classList.contains('hidden');
      if (hidden) { openSvc(); }
      else { closeSvc(); }
    });
  }
  tabTherapies?.addEventListener('click', showTherapies);
  tabTreatments?.addEventListener('click', showTreatments);
  tabTherapies?.addEventListener('pointerenter', showTherapies);
  tabTreatments?.addEventListener('pointerenter', showTreatments);

  
</script>
